<!DOCTYPE html>
<html lang="en">
<head>
   <%- include('./partials/head') %>
    <title>Write a Blog - BlogUp</title>
</head>
<body>
   <%- include('./partials/nav') %>

   <div class="add-blog-container">
      <div class="add-blog-form">
         <h1 class="mb-4">Write Your Story</h1>
         
         <form action="/blog" method="post" enctype="multipart/form-data">
            <div class="mb-4">
               <label for="formFile" class="form-label">Cover Image</label>
               <input 
                  class="form-control" 
                  type="file" 
                  id="formFile" 
                  name="coverImage"
                  accept="image/*">
               <div class="form-text">
                  Upload a cover image or leave empty to auto-generate an AI cover ‚ú®
               </div>
            </div>

            <div class="mb-4">
               <label for="titleInput" class="form-label">Title</label>
               <div class="d-flex gap-2 align-items-center">
                  <input 
                     type="text" 
                     class="form-control" 
                     id="titleInput" 
                     placeholder="Enter your blog title" 
                     aria-describedby="title" 
                     name="title"
                     required>
                  <button 
                     type="button" 
                     class="btn btn-outline-primary" 
                     id="aiSuggestBtn"
                     title="Get AI title suggestions">
                     ‚ú® AI
                  </button>
               </div>
               <div id="titleSuggestions" class="mt-2"></div>
            </div>

            <div class="mb-4">
               <label for="floatingTextarea" class="form-label">Content (Markdown)</label>
               <div class="markdown-editor-container">
                  <div class="markdown-editor-wrapper">
                     <div class="markdown-tabs">
                        <button type="button" class="markdown-tab active" data-tab="write">Write</button>
                        <button type="button" class="markdown-tab" data-tab="preview">Preview</button>
                     </div>
                     <div class="markdown-write-panel active" id="writePanel">
                        <textarea 
                           class="form-control markdown-editor" 
                           placeholder="Write your blog content in Markdown format...

# Heading 1
## Heading 2
### Heading 3

**Bold text** and *italic text*

- List item 1
- List item 2

[Link text](url)

\`\`\`code\`\`\`" 
                           id="floatingTextarea" 
                           name="body"
                           required></textarea>
                     </div>
                     <div class="markdown-preview-panel" id="previewPanel">
                        <div class="markdown-preview markdown-body"></div>
                     </div>
                  </div>
                  <div class="markdown-help">
                     <small class="text-muted">
                        üí° Use Markdown syntax: **bold**, *italic*, # headings, - lists, \`code\`, [links](url)
                     </small>
                  </div>
               </div>
            </div>

            <div class="d-flex gap-3">
               <button type="submit" class="btn-modern">Publish</button>
               <a href="/" class="btn-modern-outline">Cancel</a>
            </div>
         </form>
      </div>
   </div>   

   <%- include('./partials/script') %>
   
   <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
   <script>
      const aiSuggestBtn = document.getElementById('aiSuggestBtn');
      const titleInput = document.getElementById('titleInput');
      const contentInput = document.getElementById('floatingTextarea');
      const suggestionsDiv = document.getElementById('titleSuggestions');
      const writePanel = document.getElementById('writePanel');
      const previewPanel = document.getElementById('previewPanel');
      const previewDiv = previewPanel.querySelector('.markdown-preview');
      const tabs = document.querySelectorAll('.markdown-tab');

      // Configure marked
      if (typeof marked !== 'undefined') {
         marked.setOptions({
            breaks: true,
            gfm: true,
         });
      }

      // Tab switching
      tabs.forEach(tab => {
         tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;
            
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            writePanel.classList.remove('active');
            previewPanel.classList.remove('active');
            
            if (tabName === 'write') {
               writePanel.classList.add('active');
            } else {
               previewPanel.classList.add('active');
               updatePreview();
            }
         });
      });

      // Live preview update
      function updatePreview() {
         const markdown = contentInput.value;
         if (typeof marked !== 'undefined') {
            previewDiv.innerHTML = marked.parse(markdown);
         } else {
            previewDiv.innerHTML = '<p class="text-muted">Markdown preview not available. Please install marked library.</p>';
         }
      }

      // Update preview on input (debounced)
      let previewTimeout;
      contentInput.addEventListener('input', () => {
         clearTimeout(previewTimeout);
         if (previewPanel.classList.contains('active')) {
            previewTimeout = setTimeout(updatePreview, 300);
         }
      });

      // AI Title Suggestions
      aiSuggestBtn.addEventListener('click', async () => {
         const content = contentInput.value.trim();
         
         if (content.length < 50) {
            suggestionsDiv.innerHTML = '<small class="text-muted">Please write at least 50 characters of content first.</small>';
            return;
         }

         aiSuggestBtn.disabled = true;
         aiSuggestBtn.innerHTML = '‚è≥ Loading...';
         suggestionsDiv.innerHTML = '<small class="text-muted">Generating AI suggestions...</small>';

         try {
            const response = await fetch('/blog/api/suggest-titles', {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({ content })
            });

            const data = await response.json();
            
            if (data.titles && data.titles.length > 0) {
               suggestionsDiv.innerHTML = '<small class="text-muted mb-2 d-block">Click a suggestion to use it:</small>';
               data.titles.forEach(title => {
                  const btn = document.createElement('button');
                  btn.type = 'button';
                  btn.className = 'btn btn-sm btn-outline-secondary me-2 mb-2';
                  btn.textContent = title;
                  btn.onclick = () => titleInput.value = title;
                  suggestionsDiv.appendChild(btn);
               });
            } else {
               suggestionsDiv.innerHTML = '<small class="text-danger">No suggestions available. Try again.</small>';
            }
         } catch (error) {
            suggestionsDiv.innerHTML = '<small class="text-danger">Error generating suggestions. Please try again.</small>';
         } finally {
            aiSuggestBtn.disabled = false;
            aiSuggestBtn.innerHTML = '‚ú® AI';
         }
      });
   </script>
</body>
</html>