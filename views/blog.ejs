<!DOCTYPE html>
<html lang="en">
<head>
   <%- include('./partials/head') %>
    <title><%= blog.title %> - BlogUp</title>
</head>
<body>
   <%- include('./partials/nav') %>
   
   <div class="blog-reading-container">
      <!-- Left Sidebar - Table of Contents -->
      <aside class="blog-sidebar blog-sidebar-left">
         <div class="sidebar-content">
            <div class="toc-container">
               <h3 class="toc-title">Contents</h3>
               <nav class="toc-nav" id="tableOfContents"></nav>
            </div>
         </div>
      </aside>

      <!-- Main Content -->
      <main class="blog-main">
         <article>
            <header class="blog-header">
               <h1 class="blog-title"><%= blog.title %></h1>
               
               <% if (blog.summary) { 
                  const formattedSummary = blog.summary.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
               %>
                  <div class="blog-summary">
                     <strong>‚ú® AI Summary:</strong> <%- formattedSummary %>
                  </div>
               <% } %>
               
               <div class="blog-meta">
                  <div class="blog-author-mini">
                     <img src="<%= blog.createdBy.profileImage %>" alt="<%= blog.createdBy.fullName %>" />
                     <span><%= blog.createdBy.fullName %></span>
                  </div>
                  <div class="blog-date">
                     <%= new Date(blog.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %>
                  </div>
               </div>
            </header>

            <% if (blog.coverImageUrl) { %>
               <img src="<%= blog.coverImageUrl %>" alt="<%= blog.title %>" class="blog-cover" />
            <% } %>

            <div class="blog-content">
               <div class="blog-body markdown-body">
                  <%- markdownContent %>
               </div>
            </div>
            
            <!-- Reactions Section -->
            <div class="blog-reactions" data-user-logged-in="<%= locals.user ? 'true' : 'false' %>">
               <h3 class="reactions-title">What do you think?</h3>
               <div class="reactions-container">
                  <button 
                     class="reaction-btn <%= locals.user && blog.reactions?.heart?.users?.some(id => id.toString() === user._id.toString()) ? 'active' : '' %>" 
                     data-reaction="heart" 
                     data-blog-id="<%= blog._id %>">
                     <span class="reaction-icon">‚ù§Ô∏è</span>
                     <span class="reaction-count" id="heart-count"><%= blog.reactions?.heart?.count || 0 %></span>
                  </button>
                  <button 
                     class="reaction-btn <%= locals.user && blog.reactions?.thumbsUp?.users?.some(id => id.toString() === user._id.toString()) ? 'active' : '' %>" 
                     data-reaction="thumbsUp" 
                     data-blog-id="<%= blog._id %>">
                     <span class="reaction-icon">üëç</span>
                     <span class="reaction-count" id="thumbsUp-count"><%= blog.reactions?.thumbsUp?.count || 0 %></span>
                  </button>
                  <button 
                     class="reaction-btn <%= locals.user && blog.reactions?.informative?.users?.some(id => id.toString() === user._id.toString()) ? 'active' : '' %>" 
                     data-reaction="informative" 
                     data-blog-id="<%= blog._id %>">
                     <span class="reaction-icon">üí°</span>
                     <span class="reaction-count" id="informative-count"><%= blog.reactions?.informative?.count || 0 %></span>
                  </button>
               </div>
               <div class="reaction-status" id="reactionStatus"></div>
            </div>
         </article>
      </main>

      <!-- Right Sidebar - Author & Metadata -->
      <aside class="blog-sidebar blog-sidebar-right">
         <div class="sidebar-content">
            <div class="author-card">
               <img src="<%= blog.createdBy.profileImage %>" alt="<%= blog.createdBy.fullName %>" class="author-avatar" />
               <h4 class="author-name"><%= blog.createdBy.fullName %></h4>
               <p class="author-bio">Blog author</p>
            </div>
            
            <div class="reading-stats">
               <div class="stat-item">
                  <span class="stat-label">Reading time</span>
                  <span class="stat-value" id="readingTime">-</span>
               </div>
               <div class="stat-item">
                  <span class="stat-label">Words</span>
                  <span class="stat-value" id="wordCount">-</span>
               </div>
            </div>
            
            <div class="reading-progress">
               <div class="progress-bar" id="readingProgress"></div>
            </div>
         </div>
      </aside>
   </div>

      <section class="comments-section">
         <h2 class="comments-title">
            <%= comments.length %> <%= comments.length === 1 ? 'Comment' : 'Comments' %>
         </h2>

         <% if (!locals.user) { %>
            <div class="comment-signup-prompt">
               <p class="signup-text">üí¨ Want to join the conversation?</p>
               <p class="signup-subtext">Sign in or sign up to share your thoughts!</p>
               <div class="signup-actions">
                  <a href="/user/signin" class="btn-modern">Sign In</a>
                  <a href="/user/signup" class="btn-modern-outline">Sign Up</a>
               </div>
            </div>
         <% } %>

         <% if (locals.user) { %> 
            <form id="commentForm" action="/blog/comment/<%= blog._id %>" method="post" class="comment-form">
               <div class="comment-form-header">
                  <img src="<%= user.profileImageURL && user.profileImageURL.startsWith('.') ? user.profileImageURL.slice(1) : (user.profileImageURL || '/images/avatar.avif') %>" alt="Your avatar" />
                  <div style="flex-grow: 1;">
                     <textarea 
                        id="commentInput" 
                        name="content" 
                        rows="4" 
                        placeholder="Share your thoughts..."
                        required></textarea>
                  </div>
               </div>
               <div class="comment-form-actions">
                  <button type="button" class="btn-modern-outline" onclick="document.getElementById('commentForm').reset();">Cancel</button>
                  <button type="submit" class="btn-modern">Post Comment</button>
               </div>
            </form>
         <% } %>

         <div class="comments-list">
            <% if (comments && comments.length > 0) { %>
               <% comments.forEach(comment => { %>
                  <div class="comment-item">
                     <img 
                        src="<%= comment.createdBy.profileImage %>" 
                        alt="<%= comment.createdBy.fullName %>" 
                        class="comment-avatar" />
                     <div class="comment-content">
                        <h5 class="comment-author"><%= comment.createdBy.fullName %></h5>
                        <p class="comment-text"><%= comment.content %></p>
                     </div>
                  </div>
               <% }) %>
            <% } else { %>
               <p class="text-muted text-center py-4">No comments yet. Be the first to share your thoughts!</p>
            <% } %>
         </div>
      </section>
   </div>

   <%- include('./partials/script') %>
   
   <script>
      // Generate Table of Contents
      function generateTOC() {
         const headings = document.querySelectorAll('.markdown-body h1, .markdown-body h2, .markdown-body h3');
         const tocNav = document.getElementById('tableOfContents');
         
         if (headings.length === 0) {
            tocNav.innerHTML = '<p class="text-muted">No headings found</p>';
            return;
         }
         
         let tocHTML = '<ul class="toc-list">';
         headings.forEach((heading, index) => {
            const id = `heading-${index}`;
            heading.id = id;
            
            const level = heading.tagName.charAt(1);
            const text = heading.textContent;
            const indent = level === '1' ? '' : level === '2' ? 'ml-2' : 'ml-4';
            
            tocHTML += `<li class="toc-item ${indent}"><a href="#${id}" class="toc-link" title="${text}">${text}</a></li>`;
         });
         tocHTML += '</ul>';
         
         tocNav.innerHTML = tocHTML;
         
         // Smooth scroll for TOC links
         tocNav.querySelectorAll('.toc-link').forEach(link => {
            link.addEventListener('click', (e) => {
               e.preventDefault();
               const targetId = link.getAttribute('href').substring(1);
               const target = document.getElementById(targetId);
               if (target) {
                  target.scrollIntoView({ behavior: 'smooth', block: 'start' });
               }
            });
         });
      }
      
      // Calculate reading time and word count
      function calculateReadingStats() {
         const content = document.querySelector('.markdown-body');
         if (!content) return;
         
         const text = content.textContent || content.innerText || '';
         const words = text.trim().split(/\s+/).filter(word => word.length > 0);
         const wordCount = words.length;
         const readingTime = Math.ceil(wordCount / 100); // Average reading speed: 200 words/min
         
         document.getElementById('wordCount').textContent = wordCount.toLocaleString();
         document.getElementById('readingTime').textContent = `${readingTime} min`;
      }
      
      // Reading progress indicator
      function updateReadingProgress() {
         const content = document.querySelector('.blog-content');
         const progressBar = document.getElementById('readingProgress');
         if (!content || !progressBar) return;
         
         const contentTop = content.offsetTop;
         const contentHeight = content.offsetHeight;
         const windowHeight = window.innerHeight;
         const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
         
         const contentBottom = contentTop + contentHeight;
         const viewportBottom = scrollTop + windowHeight;
         
         let progress = 0;
         if (scrollTop >= contentTop) {
            const scrolled = viewportBottom - contentTop;
            progress = Math.min(100, (scrolled / contentHeight) * 100);
         }
         
         progressBar.style.width = `${progress}%`;
      }
      
      // Highlight active TOC item on scroll
      function highlightActiveTOC() {
         const headings = document.querySelectorAll('.markdown-body h1, .markdown-body h2, .markdown-body h3');
         const tocLinks = document.querySelectorAll('.toc-link');
         
         let currentHeading = '';
         const scrollPosition = window.pageYOffset + 200;
         
         headings.forEach(heading => {
            const headingTop = heading.offsetTop;
            if (scrollPosition >= headingTop) {
               currentHeading = heading.id;
            }
         });
         
         tocLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === `#${currentHeading}`) {
               link.classList.add('active');
            }
         });
      }
      
      // Handle Reactions
      const reactionsContainer = document.querySelector('.blog-reactions');
      const isUserLoggedIn = reactionsContainer ? reactionsContainer.dataset.userLoggedIn === 'true' : false;
      
      function handleReaction(reactionType, blogId) {
         if (!isUserLoggedIn) {
            document.getElementById('reactionStatus').textContent = 'Please sign in to react';
            document.getElementById('reactionStatus').style.color = 'var(--text-muted)';
            setTimeout(() => {
               document.getElementById('reactionStatus').textContent = '';
            }, 3000);
            return;
         }
         
         const btn = document.querySelector(`[data-reaction="${reactionType}"][data-blog-id="${blogId}"]`);
         const countElement = document.getElementById(`${reactionType}-count`);
         const statusElement = document.getElementById('reactionStatus');
         
         btn.disabled = true;
         
         fetch(`/blog/${blogId}/reaction`, {
            method: 'POST',
            headers: {
               'Content-Type': 'application/json',
            },
            body: JSON.stringify({ reaction: reactionType })
         })
         .then(response => response.json())
         .then(data => {
            if (data.success) {
               countElement.textContent = data.count;
               statusElement.textContent = data.message;
               statusElement.style.color = 'var(--primary-color)';
               
               // Update button state
               if (data.added) {
                  btn.classList.add('active');
               } else {
                  btn.classList.remove('active');
               }
               
               // Remove active state from other reaction buttons (user can only have one active at a time)
               // Actually, let's allow multiple reactions - so we don't remove from others
               
               setTimeout(() => {
                  statusElement.textContent = '';
               }, 2000);
            } else {
               statusElement.textContent = data.message || 'Error updating reaction';
               statusElement.style.color = 'var(--text-danger, #dc3545)';
               setTimeout(() => {
                  statusElement.textContent = '';
               }, 3000);
            }
         })
         .catch(error => {
            console.error('Error:', error);
            statusElement.textContent = 'Error updating reaction';
            statusElement.style.color = 'var(--text-danger, #dc3545)';
            setTimeout(() => {
               statusElement.textContent = '';
            }, 3000);
         })
         .finally(() => {
            btn.disabled = false;
         });
      }
      
      // Initialize reactions
      function initializeReactions() {
         const reactionButtons = document.querySelectorAll('.reaction-btn');
         reactionButtons.forEach(btn => {
            btn.addEventListener('click', () => {
               const reactionType = btn.dataset.reaction;
               const blogId = btn.dataset.blogId;
               handleReaction(reactionType, blogId);
            });
         });
      }
      
      // Initialize on page load
      document.addEventListener('DOMContentLoaded', () => {
         generateTOC();
         calculateReadingStats();
         updateReadingProgress();
         initializeReactions();
         
         window.addEventListener('scroll', () => {
            updateReadingProgress();
            highlightActiveTOC();
         });
      });
   </script>
</body>
</html>